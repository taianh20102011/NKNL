<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nhi·ªám v·ª• & Khen th∆∞·ªüng ‚Äî Nh·∫≠t k√Ω NƒÉng l·ª±c</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page { padding: 36px 20px; max-width:1100px; margin: 0 auto; }
    .missions-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-top:18px; }
    .mission-card { padding:14px; border-radius:12px; background:var(--card); border:1px solid var(--border); transition:all 0.3s; }
    .mission-card:hover { transform:translateY(-3px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
    .mission-card h4 { margin:0 0 8px 0; }
    .small-muted { color:var(--muted); font-size:0.95rem; }
    .xp-banner { margin-top:10px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .unlock { color:var(--accent); font-weight:700 }
    .mission-btn { padding:6px 10px; border:none; border-radius:8px; background:var(--accent); color:white; cursor:pointer; }
    .mission-btn[disabled] { background:gray; opacity:0.7; cursor:not-allowed; }
    .goto-btn { background:transparent; border:1px solid var(--accent); color:var(--accent); border-radius:8px; padding:6px 10px; cursor:pointer; transition:0.2s; }
    .goto-btn:hover { background:var(--accent); color:white; }
    #messagesBox { max-height:260px; overflow:auto; padding:8px; border-radius:10px; background:rgba(255,255,255,0.03); border:1px solid var(--border); }
    .msg { padding:10px; border-radius:10px; margin-bottom:8px; background: rgba(0,0,0,0.12) }
    .leaderboard-list { list-style:none; padding:0; margin:0;}
    .leaderboard-list li { padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a href="index.html" class="brand">NH·∫¨T K√ç<span>NƒÇNG L·ª∞C</span></a>
      <div class="menu" id="nav-menu">
        <a href="index.html">Trang ch·ªß</a>
        <a href="journal.html">Nh·∫≠t k√Ω</a>
        <a href="features.html">T√≠nh nƒÉng</a>
        <a href="missions.html" class="active">Nhi·ªám v·ª•</a>
      </div>
      <button id="theme-toggle" class="theme-toggle-btn">üåô</button>
    </div>
  </header>

  <main class="page">
    <h1>üéØ Nhi·ªám v·ª• & XP</h1>
    <p class="small-muted">Ho√†n th√†nh nhi·ªám v·ª• ƒë·ªÉ nh·∫≠n XP, m·ªü huy hi·ªáu v√† leo b·∫£ng x·∫øp h·∫°ng.</p>

    <div class="xp-banner">
      <div>
        <div class="small-muted">T·ªïng XP</div>
        <div style="font-size:20px;font-weight:800"><span id="xpValue">0</span> XP <span id="unlockBadge" class="unlock" style="display:none">¬∑ M·ªü kh√≥a l·ªô tr√¨nh AI!</span></div>
        <div class="small-muted">C·∫•p b·∫≠c: <span id="rankLabel">Ng∆∞·ªùi kh·ªüi ƒë·∫ßu</span></div>
      </div>
      <div>
        <button id="loginQuick" class="btn">ƒêƒÉng nh·∫≠p</button>
        <button id="syncBtn" class="btn">ƒê·ªìng b·ªô</button>
      </div>
    </div>

    <section>
      <h3 style="margin-top:18px">üéÆ Nhi·ªám v·ª• Tu·∫ßn n√†y</h3>
      <div class="missions-grid" id="missionsGrid"></div>
    </section>

    <section style="margin-top:22px">
      <div style="display:grid;grid-template-columns:1fr 320px;gap:16px">
        <div class="mission-card">
          <h3>üí¨ G√≥c ·∫©n danh</h3>
          <p class="small-muted">Chia s·∫ª c·∫£m x√∫c, n·ªó l·ª±c, ho·∫∑c minh ch·ª©ng. Tin nh·∫Øn hi·ªÉn th·ªã realtime.</p>
          <input id="anonNick" placeholder="Bi·ªát danh (t√πy ch·ªçn)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
          <textarea id="anonText" placeholder="Vi·∫øt g√¨ ƒë√≥..." style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="sendAnon" class="btn">G·ª≠i</button>
            <button id="refreshMsgs" class="btn ghost">L√†m m·ªõi</button>
          </div>
          <div id="messagesBox" style="margin-top:12px"></div>
        </div>

        <aside class="mission-card">
          <h3>üèÜ B·∫£ng x·∫øp h·∫°ng</h3>
          <ul id="leaderboard" class="leaderboard-list" style="margin-top:10px"></ul>
        </aside>
      </div>
    </section>

    <section style="margin-top:18px">
      <button id="analyzeAI" class="btn-ai">Ph√¢n t√≠ch AI (offline)</button>
      <div id="aiResult" class="ai-box small-muted" style="display:none;margin-top:10px"></div>
    </section>
  </main>

  <footer class="footer">¬© 2025 Nh·∫≠t k√Ω NƒÉng l·ª±c</footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCtp4izpF1GCH2qWpeLtZOdk33A_iNKzqg",
      authDomain: "nknl-d7b54.firebaseapp.com",
      projectId: "nknl-d7b54",
      storageBucket: "nknl-d7b54.firebasestorage.app",
      messagingSenderId: "792185587281",
      appId: "1:792185587281:web:585e98f2f87d7d59031a70"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const missions = [
      { id:"m1", title:"üß† Vi·∫øt 3 d√≤ng c·∫£m nh·∫≠n", xp:10, link:"journal.html" },
      { id:"m2", title:"üì∏ N·ªôp minh ch·ª©ng k·ªπ nƒÉng", xp:20, link:"features.html" },
      { id:"m3", title:"üéØ H·ªçc 20 t·ª´ m·ªõi", xp:15, link:"growth.html" },
      { id:"m4", title:"üí¨ ƒê√°nh gi√° 1 b·∫°n kh√°c", xp:10, link:"profile.html" },
    ];

    const xpEl = document.getElementById("xpValue");
    const rankLabel = document.getElementById("rankLabel");
    const unlockBadge = document.getElementById("unlockBadge");
    const grid = document.getElementById("missionsGrid");
    const leaderboardEl = document.getElementById("leaderboard");
    const sendAnonBtn = document.getElementById("sendAnon");
    const messagesBox = document.getElementById("messagesBox");
    let currentUser = null;
    let localXP = Number(localStorage.getItem("xp_local")||"0");
    let claimed = JSON.parse(localStorage.getItem("claimed_missions")||"{}");

    function renderMissions(){
      grid.innerHTML = "";
      missions.forEach(m=>{
        const card = document.createElement("div");
        const claimedAlready = claimed[m.id];
        card.className = "mission-card";
        card.innerHTML = `
          <h4>${m.title}</h4>
          <p class="small-muted">+${m.xp} XP</p>
          <div style="margin-top:10px;display:flex;gap:6px;align-items:center">
            <button class="mission-btn" data-id="${m.id}" ${claimedAlready?"disabled":""}>${claimedAlready?"ƒê√£ nh·∫≠n":"Nh·∫≠n XP"}</button>
            <button class="goto-btn" onclick="location.href='${m.link}'">ƒê·∫øn nhi·ªám v·ª•</button>
          </div>
        `;
        grid.appendChild(card);
      });

      grid.querySelectorAll(".mission-btn").forEach(btn=>{
        btn.addEventListener("click",async e=>{
          const id=e.target.dataset.id;
          if(claimed[id]) return alert("B·∫°n ƒë√£ nh·∫≠n XP cho nhi·ªám v·ª• n√†y r·ªìi!");
          const mission = missions.find(m=>m.id===id);
          await awardXP(mission.xp,id);
          e.target.disabled = true;
          e.target.textContent = "ƒê√£ nh·∫≠n";
        });
      });
    }

    async function awardXP(amount,id){
      if(currentUser){
        const ref = doc(db,"users",currentUser.uid);
        const snap = await getDoc(ref);
        const xp = (snap.exists()?snap.data().xp:0)+amount;
        await setDoc(ref,{xp},{merge:true});
        await setDoc(doc(db,"leaderboard",currentUser.uid),{name:currentUser.email||"User",xp},{merge:true});
      }else{
        localXP+=amount;
        localStorage.setItem("xp_local",localXP);
      }
      claimed[id]=true;
      localStorage.setItem("claimed_missions",JSON.stringify(claimed));
      updateXPUI();
      alert("Nh·∫≠n "+amount+" XP th√†nh c√¥ng!");
    }

    async function updateXPUI(){
      let xp=localXP;
      if(currentUser){
        const ref=doc(db,"users",currentUser.uid);
        const snap=await getDoc(ref);
        xp=snap.exists()?snap.data().xp:0;
      }
      xpEl.textContent=xp;
      if(xp>=50) unlockBadge.style.display="inline";
      rankLabel.textContent = xp>=200?"Chuy√™n gia":xp>=100?"Th√†nh th·∫°o":xp>=50?"Ng∆∞·ªùi h·ªçc t√≠ch c·ª±c":xp>=20?"Kh√°m ph√°":"Ng∆∞·ªùi kh·ªüi ƒë·∫ßu";
    }

    // Chat ·∫©n danh
    sendAnonBtn.onclick=async()=>{
      const text=document.getElementById("anonText").value.trim();
      const nick=document.getElementById("anonNick").value.trim()||"·∫®n danh";
      if(!text) return alert("Nh·∫≠p tin nh·∫Øn tr∆∞·ªõc khi g·ª≠i!");
      await addDoc(collection(db,"anonMessages"),{nick,text,createdAt:new Date()});
      document.getElementById("anonText").value="";
    };
    onSnapshot(query(collection(db,"anonMessages"),orderBy("createdAt","desc"),limit(20)),snap=>{
      messagesBox.innerHTML="";
      snap.forEach(d=>{
        const v=d.data();
        const div=document.createElement("div");
        div.className="msg";
        div.innerHTML=`<b>${v.nick}</b><br>${v.text}`;
        messagesBox.appendChild(div);
      });
    });

    // Leaderboard
    onSnapshot(query(collection(db,"leaderboard"),orderBy("xp","desc"),limit(10)),snap=>{
      leaderboardEl.innerHTML="";
      snap.forEach(d=>{
        const v=d.data();
        const li=document.createElement("li");
        li.innerHTML=`<span>${v.name||"Ng∆∞·ªùi"}</span><b>${v.xp||0} XP</b>`;
        leaderboardEl.appendChild(li);
      });
    });

    // Auth
    onAuthStateChanged(auth,u=>{
      currentUser=u||null;
      renderMissions();
      updateXPUI();
    });
    renderMissions(); updateXPUI();
    const q = (sel) => document.querySelector(sel);

document.addEventListener("DOMContentLoaded", () => {
  const themeToggle = q("#theme-toggle");
  const applyTheme = (theme) => {
    if (theme === "light") {
      document.documentElement.setAttribute("data-theme", "light");
    } else {
      document.documentElement.removeAttribute("data-theme");
    }
  };

  let currentTheme = localStorage.getItem("theme") || "dark";
  applyTheme(currentTheme);

  if (themeToggle) {
    themeToggle.textContent = currentTheme === "light" ? "üåû" : "üåô";

    themeToggle.addEventListener("click", () => {
      currentTheme = currentTheme === "light" ? "dark" : "light";
      applyTheme(currentTheme);
      localStorage.setItem("theme", currentTheme);
      themeToggle.textContent = currentTheme === "light" ? "üåû" : "üåô";
    });
  }
});
// üåü Navbar toggle for mobile
// Hamburger toggle
const navToggle = document.getElementById("nav-toggle");
const navMenu = document.getElementById("nav-menu");

if (navToggle && navMenu) {
  navToggle.addEventListener("click", () => {
    navMenu.classList.toggle("mobile-open");
  });
}

// ·∫®n menu khi click b√™n ngo√†i (tu·ª≥ ch·ªçn)
document.addEventListener("click", (e) => {
  if (!navMenu.contains(e.target) && !navToggle.contains(e.target)) {
    navMenu.classList.remove("mobile-open");
  }
});


  </script>
</body>
</html>
