<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nhiá»‡m vá»¥ & XP â€” Nháº­t kÃ½ NÄƒng lá»±c</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page { padding: 36px 20px; max-width:1100px; margin: 0 auto; }
    .missions-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-top:18px; }
    .mission-card { padding:14px; border-radius:12px; background:var(--card); border:1px solid var(--border); }
    .small-muted { color:var(--muted); font-size:0.95rem; }
    .xp-banner { margin-top:10px; display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .btn { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; }
    .btn[disabled]{ opacity:0.5; cursor:not-allowed; }
    .msg { padding:10px; border-radius:10px; margin-bottom:8px; background: rgba(0,0,0,0.06); }
    .leaderboard-list { list-style:none; padding:0; margin:0;}
    .leaderboard-list li { padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; }
    .goto-btn { margin-left:8px; background:transparent;border:1px solid var(--accent); color:var(--accent); padding:6px 10px; border-radius:8px; }
  </style>
</head>
<body>
<header class="nav">
  <div class="container nav-inner">
    <a href="index.html" class="brand">NHáº¬T KÃ<span>NÄ‚NG Lá»°C</span></a>
    <nav class="menu" id="nav-menu">
      <a href="index.html">Trang chá»§</a>
      <a href="journal.html">Nháº­t kÃ½</a>
      <a href="features.html">TÃ­nh nÄƒng</a>
      <a href="missions.html">Nhiá»‡m vá»¥</a>
      <a href="profile.html">Há»“ sÆ¡</a>
    </nav>
    <div class="hamburger" id="hamburger">â˜°</div>
  </div>
</header>
<main class="page">
  <h1>ğŸ¯ Nhiá»‡m vá»¥ & XP</h1>
  <div class="xp-banner">
    <div>
      <div class="small-muted">Tá»•ng XP</div>
      <div style="font-weight:800"><span id="xpValue">0</span> XP <span id="unlockBadge" style="display:none;color:var(--accent)"></span></div>
      <div class="small-muted">Cáº¥p báº­c: <span id="rankLabel">NgÆ°á»i khá»Ÿi Ä‘áº§u</span></div>
    </div>
    <div>
      <button id="loginQuick" class="btn">ÄÄƒng nháº­p</button>
    </div>
  </div>

  <h3 style="margin-top:18px">Nhiá»‡m vá»¥ Tuáº§n nÃ y</h3>
  <div class="missions-grid" id="missionsGrid"></div>

  <div style="display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:18px">
    <div class="mission-card">
      <h3>ğŸ’¬ GÃ³c áº©n danh</h3>
      <input id="anonNick" placeholder="Biá»‡t danh (tÃ¹y chá»n)" style="width:100%;padding:8px;border-radius:6px;margin-top:8px" />
      <textarea id="anonText" placeholder="Viáº¿t gÃ¬ Ä‘Ã³..." style="width:100%;margin-top:8px;padding:8px;border-radius:6px"></textarea>
      <div style="margin-top:8px"><button id="sendAnon" class="btn">Gá»­i</button></div>
      <div id="messagesBox" style="margin-top:12px;max-height:220px;overflow:auto"></div>
    </div>

    <aside class="mission-card">
      <h3>ğŸ† Báº£ng xáº¿p háº¡ng</h3>
      <ul id="leaderboard" class="leaderboard-list"></ul>
    </aside>
  </div>
</main>

<script type="module">
import { auth, db } from 'main.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCtp4izpF1GCH2qWpeLtZOdk33A_iNKzqg",
      authDomain: "nknl-d7b54.firebaseapp.com",
      projectId: "nknl-d7b54",
      storageBucket: "nknl-d7b54.firebasestorage.app",
      messagingSenderId: "792185587281",
      appId: "1:792185587281:web:585e98f2f87d7d59031a70"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

import { markMissionDone } from 'missionsTracker.js';

const missions = [
  { id: 'm1', title: 'Há»c 20 tá»« má»›i', xp: 10, link: 'growth.html' },
  { id: 'm2', title: 'Viáº¿t 3 dÃ²ng cáº£m nháº­n', xp: 5, link: 'journal.html' },
  { id: 'm3', title: 'Ná»™p minh chá»©ng ká»¹ nÄƒng', xp: 20, link: 'featuress.html' },
  { id: 'm4', title: 'ÄÃ¡nh giÃ¡ 1 báº¡n khÃ¡c', xp: 5, link: 'profile.html' }
];

const LS_COMPLETE = 'missions_complete_local';
const LS_XP = 'missions_xp_local';

const grid = document.getElementById('missionsGrid');
const xpValueEl = document.getElementById('xpValue');
const rankLabel = document.getElementById('rankLabel');
const unlockBadge = document.getElementById('unlockBadge');
const messagesBox = document.getElementById('messagesBox');
const leaderboardEl = document.getElementById('leaderboard');

let currentUser = null;

async function loadUserState() {
  let completed = JSON.parse(localStorage.getItem(LS_COMPLETE) || "{}");
  let xp = Number(localStorage.getItem(LS_XP) || "0");
  if (currentUser) {
    try {
      const uRef = doc(db, 'users', currentUser.uid);
      const uSnap = await getDoc(uRef);
      if (uSnap.exists()) {
        const d = uSnap.data();
        completed = d.completed || completed;
        xp = d.xp || xp;
        // sync local
        localStorage.setItem(LS_COMPLETE, JSON.stringify(completed));
      } else {
        // create user doc with existing local xp/state
        await setDoc(uRef, { xp, completed }, { merge: true });
      }
    } catch (err) {
      console.error('loadUserState err', err);
    }
  }
  updateXPUI(xp);
  renderMissions(completed);
}

function updateXPUI(xp) {
  xpValueEl.textContent = xp;
  unlockBadge.style.display = xp >= 50 ? 'inline' : 'none';
  if (xp >= 200) rankLabel.textContent = 'ChuyÃªn gia';
  else if (xp >= 100) rankLabel.textContent = 'ThÃ nh tháº¡o';
  else if (xp >= 50) rankLabel.textContent = 'NgÆ°á»i há»c tÃ­ch cá»±c';
  else if (xp >= 20) rankLabel.textContent = 'KhÃ¡m phÃ¡';
  else rankLabel.textContent = 'NgÆ°á»i khá»Ÿi Ä‘áº§u';
}

function renderMissions(completed) {
  const map = completed || {};
  grid.innerHTML = '';
  missions.forEach(m => {
    const s = map[m.id] || { done: false, claimed: false };
    const card = document.createElement('div');
    card.className = 'mission-card';
    const status = s.claimed ? 'âœ… ÄÃ£ nháº­n XP' : (s.done ? 'ğŸ•“ ÄÃ£ hoÃ n thÃ nh â€” ChÆ°a nháº­n' : 'ğŸ”’ ChÆ°a hoÃ n thÃ nh');
    const btnDisabled = !s.done || s.claimed;
    card.innerHTML = `
      <h4>${m.title}</h4>
      <div class="small-muted">${status}</div>
      <div style="margin-top:10px">
        <button class="btn claim-btn" data-id="${m.id}" ${btnDisabled ? 'disabled' : ''}>Nháº­n ${m.xp} XP</button>
        <button class="goto-btn" data-link="${m.link}">Äáº¿n nhiá»‡m vá»¥</button>
      </div>
    `;
    grid.appendChild(card);
  });

  // attach events
  grid.querySelectorAll('.goto-btn').forEach(b=>{
    b.addEventListener('click', e => {
      const l = e.currentTarget.dataset.link;
      window.location.href = l;
    });
  });

  grid.querySelectorAll('.claim-btn').forEach(b=>{
    b.addEventListener('click', async e=>{
      const id = e.currentTarget.dataset.id;
      await claimXP(id);
    });
  });
}

async function claimXP(missionId) {
  // read latest completed map
  const localMap = JSON.parse(localStorage.getItem(LS_COMPLETE) || "{}");
  const state = localMap[missionId] || { done:false, claimed:false };
  if (!state.done) return alert('Báº¡n chÆ°a hoÃ n thÃ nh nhiá»‡m vá»¥, hÃ£y lÃ m nhiá»‡m vá»¥ trÆ°á»›c khi nháº­n XP.');
  if (state.claimed) return alert('Báº¡n Ä‘Ã£ nháº­n XP cho nhiá»‡m vá»¥ nÃ y rá»“i.');
  const mission = missions.find(m => m.id === missionId);
  if (!mission) return;
  // optimistic: set claimed locally
  localMap[missionId] = { done: true, claimed: true };
  localStorage.setItem(LS_COMPLETE, JSON.stringify(localMap));
  if (currentUser) {
    try {
      const uRef = doc(db, 'users', currentUser.uid);
      const uSnap = await getDoc(uRef);
      const prev = uSnap.exists() ? (uSnap.data().xp || 0) : 0;
      const newXP = prev + mission.xp;
      await setDoc(uRef, { xp: newXP, completed: localMap }, { merge: true });
      await setDoc(doc(db,'leaderboard', currentUser.uid), { uid: currentUser.uid, name: currentUser.email || currentUser.displayName, xp: newXP, updatedAt: new Date().toISOString() }, { merge: true });
      updateXPUI(newXP);
    } catch (err) {
      console.error('claimXP err', err);
      // rollback local claimed
      const rollback = JSON.parse(localStorage.getItem(LS_COMPLETE) || "{}");
      if (rollback[missionId]) rollback[missionId].claimed = false;
      localStorage.setItem(LS_COMPLETE, JSON.stringify(rollback));
      return alert('KhÃ´ng thá»ƒ nháº­n XP lÃºc nÃ y. Vui lÃ²ng thá»­ láº¡i.');
    }
  } else {
    // local fallback xp
    let cur = Number(localStorage.getItem(LS_XP) || "0");
    cur += mission.xp;
    localStorage.setItem(LS_XP, String(cur));
    updateXPUI(cur);
  }

  renderMissions(JSON.parse(localStorage.getItem(LS_COMPLETE) || "{}"));
  alert(`Báº¡n nháº­n Ä‘Æ°á»£c ${mission.xp} XP!`);
}

// anon chat
document.getElementById('sendAnon').addEventListener('click', async ()=>{
  const text = document.getElementById('anonText').value.trim();
  const nick = document.getElementById('anonNick').value.trim() || 'áº¨n danh';
  if (!text) return alert('Nháº­p tin nháº¯n trÆ°á»›c khi gá»­i');
  try {
    await addDoc(collection(db,'anonMessages'), { nick, text, createdAt: new Date() });
    document.getElementById('anonText').value = '';
  } catch (err) {
    console.error('sendAnon err', err);
    alert('Gá»­i tháº¥t báº¡i');
  }
});

// realtime messages
onSnapshot(query(collection(db,'anonMessages'), orderBy('createdAt','desc'), limit(30)), snap => {
  messagesBox.innerHTML = '';
  const rows = [];
  snap.forEach(d => rows.push(d.data()));
  rows.reverse().forEach(r => {
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<div style="font-size:12px;color:var(--muted)">${r.nick} Â· ${r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : ''}</div><div style="margin-top:6px">${r.text}</div>`;
    messagesBox.appendChild(div);
  });
});

// leaderboard realtime
onSnapshot(query(collection(db,'leaderboard'), orderBy('xp','desc'), limit(10)), snap => {
  leaderboardEl.innerHTML = '';
  snap.forEach(d => {
    const v = d.data();
    const li = document.createElement('li');
    li.innerHTML = `<span>${v.name||'NgÆ°á»i'}</span><strong>${v.xp||0} XP</strong>`;
    leaderboardEl.appendChild(li);
  });
});

// auth listener
onAuthStateChanged(auth, async user => {
  currentUser = user || null;
  await loadUserState();
});

// quick login redirect
document.getElementById('loginQuick').addEventListener('click', ()=> location.href='login.html');
const q = (sel) => document.querySelector(sel);

document.addEventListener("DOMContentLoaded", () => {
  const themeToggle = q("#theme-toggle");
  const applyTheme = (theme) => {
    if (theme === "light") {
      document.documentElement.setAttribute("data-theme", "light");
    } else {
      document.documentElement.removeAttribute("data-theme");
    }
  };

  let currentTheme = localStorage.getItem("theme") || "dark";
  applyTheme(currentTheme);

  if (themeToggle) {
    themeToggle.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";

    themeToggle.addEventListener("click", () => {
      currentTheme = currentTheme === "light" ? "dark" : "light";
      applyTheme(currentTheme);
      localStorage.setItem("theme", currentTheme);
      themeToggle.textContent = currentTheme === "light" ? "ğŸŒ" : "ğŸŒ™";
    });
  }
});
// ğŸŒŸ Navbar toggle for mobile
// Hamburger toggle
const navToggle = document.getElementById("nav-toggle");
const navMenu = document.getElementById("nav-menu");

if (navToggle && navMenu) {
  navToggle.addEventListener("click", () => {
    navMenu.classList.toggle("mobile-open");
  });
}

// áº¨n menu khi click bÃªn ngoÃ i (tuá»³ chá»n)
document.addEventListener("click", (e) => {
  if (!navMenu.contains(e.target) && !navToggle.contains(e.target)) {
    navMenu.classList.remove("mobile-open");
  }
});
</script>
</body>
</html>
