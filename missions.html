<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nhiá»‡m vá»¥ & XP â€” Nháº­t kÃ½ NÄƒng lá»±c</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page { padding: 36px 20px; max-width:1100px; margin: 0 auto; }
    .missions-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-top:18px; }
    .mission-card { padding:14px; border-radius:12px; background:var(--card); border:1px solid var(--border); transition:all 0.3s; }
    .mission-card:hover { transform:translateY(-3px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
    .small-muted { color:var(--muted); font-size:0.95rem; }
    .goto-btn { background:transparent;border:1px solid var(--accent);color:var(--accent);padding:6px 10px;border-radius:8px;cursor:pointer; }
    .goto-btn:hover { background:var(--accent);color:white; }
    .mission-btn[disabled]{opacity:0.6;cursor:not-allowed;}
    .leaderboard-list { list-style:none; padding:0; margin:0; }
    .leaderboard-list li { padding:8px 0; display:flex; justify-content:space-between; border-bottom:1px solid var(--border); }
    .msg { padding:8px; background:rgba(0,0,0,0.06); border-radius:8px; margin-bottom:6px; }
  </style>
</head>
<body>
<header class="nav">
  <div class="container nav-inner">
    <a href="index.html" class="brand">NHáº¬T KÃ<span>NÄ‚NG Lá»°C</span></a>
    <button id="nav-toggle" class="hamburger">â˜°</button>
    <nav class="menu" id="nav-menu">
      <a href="index.html">Trang chá»§</a>
      <a href="journal.html">Nháº­t kÃ½</a>
      <a href="features.html">TÃ­nh nÄƒng</a>
      <a href="missions.html" class="active">Nhiá»‡m vá»¥</a>
      <a href="profile.html">Há»“ sÆ¡</a>
    </nav>
    <button id="theme-toggle" class="theme-toggle-btn">ğŸŒ™</button>
  </div>
</header>

<main class="page">
  <h1>ğŸ¯ Nhiá»‡m vá»¥ & XP</h1>
  <p class="small-muted">HoÃ n thÃ nh nhiá»‡m vá»¥ Ä‘á»ƒ nháº­n XP, má»Ÿ huy hiá»‡u vÃ  leo báº£ng xáº¿p háº¡ng.</p>

  <div class="xp-banner">
    <div>
      <div class="small-muted">Tá»•ng XP</div>
      <div style="font-weight:800"><span id="xpValue">0</span> XP <span id="unlockBadge" style="display:none;color:var(--accent)">Â· Má»Ÿ khÃ³a AI!</span></div>
      <div class="small-muted">Cáº¥p báº­c: <span id="rankLabel">NgÆ°á»i khá»Ÿi Ä‘áº§u</span></div>
    </div>
  </div>

  <h3 style="margin-top:18px">ğŸ® Nhiá»‡m vá»¥ Tuáº§n nÃ y</h3>
  <div class="missions-grid" id="missionsGrid"></div>

  <div style="display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:24px">
    <div class="mission-card">
      <h3>ğŸ’¬ GÃ³c áº©n danh</h3>
      <p class="small-muted">Chia sáº» cáº£m xÃºc, ná»— lá»±c, hoáº·c minh chá»©ng. Tin nháº¯n realtime.</p>
      <input id="anonNick" placeholder="Biá»‡t danh (tÃ¹y chá»n)" style="width:100%;margin-top:6px;padding:8px;border-radius:6px;border:1px solid var(--border);">
      <textarea id="anonText" placeholder="Viáº¿t gÃ¬ Ä‘Ã³..." style="width:100%;margin-top:8px;padding:8px;border-radius:6px;border:1px solid var(--border);"></textarea>
      <button id="sendAnon" class="btn" style="margin-top:8px">Gá»­i</button>
      <div id="messagesBox" style="margin-top:10px;max-height:260px;overflow:auto;"></div>
    </div>

    <aside class="mission-card">
      <h3>ğŸ† Báº£ng xáº¿p háº¡ng</h3>
      <ul id="leaderboard" class="leaderboard-list"></ul>
    </aside>
  </div>
</main>

<footer class="footer">Â© 2025 Nháº­t kÃ½ NÄƒng lá»±c</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtp4izpF1GCH2qWpeLtZOdk33A_iNKzqg",
  authDomain: "nknl-d7b54.firebaseapp.com",
  projectId: "nknl-d7b54"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ğŸ¯ Danh sÃ¡ch nhiá»‡m vá»¥
const missionsList = [
  { id: 'm1', title: 'ğŸ§  Viáº¿t 3 dÃ²ng cáº£m nháº­n', xp: 10, link: 'journal.html' },
  { id: 'm2', title: 'ğŸ“¸ Ná»™p minh chá»©ng ká»¹ nÄƒng', xp: 20, link: 'featuress.html' },
  { id: 'm3', title: 'ğŸ¯ Há»c 20 tá»« má»›i', xp: 15, link: 'growth.html' },
  { id: 'm4', title: 'ğŸ’¬ ÄÃ¡nh giÃ¡ 1 báº¡n khÃ¡c', xp: 10, link: 'profile.html' }
];

let currentUser = null;
let userMissions = {};
let userXP = 0;

// -----------------------------
// ğŸš€ Cáº­p nháº­t giao diá»‡n XP
// -----------------------------
function updateXPUI(xp) {
  const xpVal = document.getElementById('xpValue');
  const rankLabel = document.getElementById('rankLabel');
  const unlockBadge = document.getElementById('unlockBadge');

  if (!xpVal) return;
  xpVal.textContent = xp;
  unlockBadge.style.display = xp >= 50 ? 'inline' : 'none';
  rankLabel.textContent =
    xp >= 200 ? 'ChuyÃªn gia' :
    xp >= 100 ? 'ThÃ nh tháº¡o' :
    xp >= 50 ? 'NgÆ°á»i há»c tÃ­ch cá»±c' :
    xp >= 20 ? 'KhÃ¡m phÃ¡' : 'NgÆ°á»i khá»Ÿi Ä‘áº§u';
}

// -----------------------------
// ğŸ§© Hiá»ƒn thá»‹ danh sÃ¡ch nhiá»‡m vá»¥
// -----------------------------
function renderMissions() {
  const grid = document.getElementById('missionsGrid');
  grid.innerHTML = '';

  missionsList.forEach(m => {
    const s = userMissions[m.id] || { done: false, claimed: false };
    const canClaim = s.done && !s.claimed;
    const status = s.claimed
      ? 'âœ… ÄÃ£ nháº­n XP'
      : s.done
      ? 'ğŸ•“ ÄÃ£ hoÃ n thÃ nh â€” ChÆ°a nháº­n'
      : 'ğŸ”’ ChÆ°a hoÃ n thÃ nh';

    const card = document.createElement('div');
    card.className = 'mission-card';
    card.innerHTML = `
      <h4>${m.title}</h4>
      <p class="small-muted">${status}</p>
      <div style="margin-top:10px">
        <button class="btn mission-btn" data-id="${m.id}" ${canClaim ? '' : 'disabled'}>
          Nháº­n ${m.xp} XP
        </button>
        <button class="goto-btn" onclick="location.href='${m.link}'">Äáº¿n nhiá»‡m vá»¥</button>
      </div>
    `;
    grid.appendChild(card);
  });

  grid.querySelectorAll('.mission-btn').forEach(btn => {
    btn.addEventListener('click', () => claimXP(btn.dataset.id));
  });
}

// -----------------------------
// ğŸ Nháº­n XP
// -----------------------------
async function claimXP(id) {
  const user = auth.currentUser;
  if (!user) {
    alert('âš ï¸ HÃ£y Ä‘Äƒng nháº­p Ä‘á»ƒ nháº­n XP!');
    return;
  }

  const ref = doc(db, 'users', user.uid);
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : {};
  const missions = data.missions || {};
  const xp = data.xp || 0;

  const mission = missions[id];
  const missionData = missionsList.find(m => m.id === id);

  if (!mission || !mission.done) {
    alert('âŒ Báº¡n chÆ°a hoÃ n thÃ nh nhiá»‡m vá»¥ nÃ y!');
    return;
  }
  if (mission.claimed) {
    alert('âš ï¸ Báº¡n Ä‘Ã£ nháº­n XP rá»“i!');
    return;
  }

  const newXP = xp + (missionData?.xp || 0);
  missions[id].claimed = true;

  await setDoc(ref, { xp: newXP, missions }, { merge: true });
  userMissions = missions;
  userXP = newXP;
  updateXPUI(newXP);
  renderMissions();

  alert(`ğŸ‰ Nháº­n ${missionData.xp} XP thÃ nh cÃ´ng cho nhiá»‡m vá»¥ "${missionData.title}"!`);
}

// -----------------------------
// ğŸ’¬ GÃ³c áº©n danh (áº©n danh chat box)
// -----------------------------
document.getElementById('sendAnon').addEventListener('click', async () => {
  const nick = document.getElementById('anonNick').value.trim() || 'áº¨n danh';
  const text = document.getElementById('anonText').value.trim();
  if (!text) return alert('HÃ£y viáº¿t gÃ¬ Ä‘Ã³!');
  await addDoc(collection(db, 'anonMessages'), { nick, text, createdAt: new Date() });
  document.getElementById('anonText').value = '';
});

onSnapshot(query(collection(db, 'anonMessages'), orderBy('createdAt', 'desc'), limit(20)), snap => {
  const box = document.getElementById('messagesBox');
  box.innerHTML = '';
  snap.forEach(d => {
    const v = d.data();
    const div = document.createElement('div');
    div.className = 'msg';
    div.innerHTML = `<b>${v.nick}</b><br>${v.text}`;
    box.appendChild(div);
  });
});

// -----------------------------
// ğŸ† Báº£ng xáº¿p háº¡ng
// -----------------------------
onSnapshot(query(collection(db, 'leaderboard'), orderBy('xp', 'desc'), limit(10)), snap => {
  const lb = document.getElementById('leaderboard');
  lb.innerHTML = '';
  snap.forEach(d => {
    const v = d.data();
    const li = document.createElement('li');
    li.innerHTML = `<span>${v.name || 'NgÆ°á»i dÃ¹ng'}</span><b>${v.xp || 0} XP</b>`;
    lb.appendChild(li);
  });
});

// -----------------------------
// ğŸ‘¤ Auth state
// -----------------------------
onAuthStateChanged(auth, async u => {
  currentUser = u;
  if (u) {
    const ref = doc(db, 'users', u.uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      userMissions = data.missions || {};
      userXP = data.xp || 0;
      updateXPUI(userXP);
    } else {
      await setDoc(ref, { xp: 0, missions: {} });
      userMissions = {};
      userXP = 0;
      updateXPUI(0);
    }
  } else {
    userMissions = {};
    userXP = 0;
    updateXPUI(0);
  }
  renderMissions();
});

// -----------------------------
// ğŸŒ— Theme toggle + Navbar
// -----------------------------
const q = s => document.querySelector(s);
document.addEventListener('DOMContentLoaded', () => {
  const themeToggle = q('#theme-toggle');
  const applyTheme = t =>
    t === 'light'
      ? document.documentElement.setAttribute('data-theme', 'light')
      : document.documentElement.removeAttribute('data-theme');
  let theme = localStorage.getItem('theme') || 'dark';
  applyTheme(theme);
  if (themeToggle) {
    themeToggle.textContent = theme === 'light' ? 'ğŸŒ' : 'ğŸŒ™';
    themeToggle.addEventListener('click', () => {
      theme = theme === 'light' ? 'dark' : 'light';
      applyTheme(theme);
      localStorage.setItem('theme', theme);
      themeToggle.textContent = theme === 'light' ? 'ğŸŒ' : 'ğŸŒ™';
    });
  }
});
const navToggle = document.getElementById('nav-toggle');
const navMenu = document.getElementById('nav-menu');
if (navToggle && navMenu) {
  navToggle.addEventListener('click', () => navMenu.classList.toggle('mobile-open'));
  document.addEventListener('click', e => {
    if (!navMenu.contains(e.target) && !navToggle.contains(e.target)) navMenu.classList.remove('mobile-open');
  });
}
</script>

</body>
</html>
