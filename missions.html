<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nhiá»‡m vá»¥ & XP â€” Nháº­t kÃ½ NÄƒng lá»±c</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page { padding: 36px 20px; max-width:1100px; margin: 0 auto; }
    .missions-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-top:18px; }
    .mission-card { padding:14px; border-radius:12px; background:var(--card); border:1px solid var(--border); transition:all 0.3s; }
    .mission-card:hover { transform:translateY(-3px); box-shadow:0 4px 10px rgba(0,0,0,0.15); }
    .small-muted { color:var(--muted); font-size:0.95rem; }
    .goto-btn { background:transparent;border:1px solid var(--accent);color:var(--accent);padding:6px 10px;border-radius:8px;cursor:pointer; }
    .goto-btn:hover { background:var(--accent);color:white; }
    .mission-btn[disabled]{opacity:0.6;cursor:not-allowed;}
  </style>
</head>
<body>
<header class="nav">
  <div class="container nav-inner">
    <a href="index.html" class="brand">NHáº¬T KÃ<span>NÄ‚NG Lá»°C</span></a>
    <nav class="menu" id="nav-menu">
      <a href="index.html">Trang chá»§</a>
      <a href="journal.html">Nháº­t kÃ½</a>
      <a href="features.html">TÃ­nh nÄƒng</a>
      <a href="missions.html" class="active">Nhiá»‡m vá»¥</a>
      <a href="profile.html">Há»“ sÆ¡</a>
    </nav>
    <button id="theme-toggle" class="theme-toggle-btn">ğŸŒ™</button>
  </div>
</header>

<main class="page">
  <h1>ğŸ¯ Nhiá»‡m vá»¥ & XP</h1>
  <p class="small-muted">HoÃ n thÃ nh nhiá»‡m vá»¥ Ä‘á»ƒ nháº­n XP, má»Ÿ huy hiá»‡u vÃ  leo báº£ng xáº¿p háº¡ng.</p>

  <div class="xp-banner">
    <div>
      <div class="small-muted">Tá»•ng XP</div>
      <div style="font-weight:800"><span id="xpValue">0</span> XP <span id="unlockBadge" style="display:none;color:var(--accent)">Â· Má»Ÿ khÃ³a AI!</span></div>
      <div class="small-muted">Cáº¥p báº­c: <span id="rankLabel">NgÆ°á»i khá»Ÿi Ä‘áº§u</span></div>
    </div>
    <button id="loginQuick" class="btn">ÄÄƒng nháº­p</button>
  </div>

  <h3 style="margin-top:18px">ğŸ® Nhiá»‡m vá»¥ Tuáº§n nÃ y</h3>
  <div class="missions-grid" id="missionsGrid"></div>

  <div style="display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:18px">
    <div class="mission-card">
      <h3>ğŸ’¬ GÃ³c áº©n danh</h3>
      <input id="anonNick" placeholder="Biá»‡t danh (tÃ¹y chá»n)" style="width:100%;padding:8px;border-radius:6px;margin-top:8px">
      <textarea id="anonText" placeholder="Viáº¿t gÃ¬ Ä‘Ã³..." style="width:100%;margin-top:8px;padding:8px;border-radius:6px"></textarea>
      <div style="margin-top:8px"><button id="sendAnon" class="btn">Gá»­i</button></div>
      <div id="messagesBox" style="margin-top:12px;max-height:220px;overflow:auto"></div>
    </div>

    <aside class="mission-card">
      <h3>ğŸ† Báº£ng xáº¿p háº¡ng</h3>
      <ul id="leaderboard" style="list-style:none;padding:0;margin:0"></ul>
    </aside>
  </div>
</main>

<footer class="footer">Â© 2025 Nháº­t kÃ½ NÄƒng lá»±c</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtp4izpF1GCH2qWpeLtZOdk33A_iNKzqg",
  authDomain: "nknl-d7b54.firebaseapp.com",
  projectId: "nknl-d7b54",
  storageBucket: "nknl-d7b54.firebasestorage.app",
  messagingSenderId: "792185587281",
  appId: "1:792185587281:web:585e98f2f87d7d59031a70"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const missions = [
  { id:'m1', title:'ğŸ§  Viáº¿t 3 dÃ²ng cáº£m nháº­n', xp:10, link:'journal.html' },
  { id:'m2', title:'ğŸ“¸ Ná»™p minh chá»©ng ká»¹ nÄƒng', xp:20, link:'features.html' },
  { id:'m3', title:'ğŸ¯ Há»c 20 tá»« má»›i', xp:15, link:'growth.html' },
  { id:'m4', title:'ğŸ’¬ ÄÃ¡nh giÃ¡ 1 báº¡n khÃ¡c', xp:10, link:'profile.html' }
];

let currentUser=null;
let userState = JSON.parse(localStorage.getItem('missions_state') || '{}');
let localXP = Number(localStorage.getItem('xp_local') || '0');

function updateXPUI(xp){
  document.getElementById('xpValue').textContent = xp;
  const unlock = document.getElementById('unlockBadge');
  const rank = document.getElementById('rankLabel');
  unlock.style.display = xp>=50 ? 'inline':'none';
  rank.textContent = xp>=200?'ChuyÃªn gia':xp>=100?'ThÃ nh tháº¡o':xp>=50?'NgÆ°á»i há»c tÃ­ch cá»±c':xp>=20?'KhÃ¡m phÃ¡':'NgÆ°á»i khá»Ÿi Ä‘áº§u';
}

function renderMissions(){
  const grid=document.getElementById('missionsGrid');
  grid.innerHTML='';
  missions.forEach(m=>{
    const state = userState[m.id] || {done:false,claimed:false};
    const card=document.createElement('div');
    card.className='mission-card'+(state.done&&!state.claimed?' active-mission':'');
    const status = state.claimed ? 'âœ… ÄÃ£ nháº­n XP' : (state.done?'ğŸ•“ ÄÃ£ hoÃ n thÃ nh â€” ChÆ°a nháº­n':'ğŸ”’ ChÆ°a hoÃ n thÃ nh');
    card.innerHTML=`
      <h4>${m.title}</h4>
      <div class="small-muted">${status}</div>
      <div style="margin-top:10px">
        <button class="btn mission-btn" data-id="${m.id}" ${(!state.done||state.claimed)?'disabled':''}>Nháº­n ${m.xp} XP</button>
        <button class="goto-btn" data-link="${m.link}">Äáº¿n nhiá»‡m vá»¥</button>
      </div>`;
    grid.appendChild(card);
  });

  grid.querySelectorAll('.goto-btn').forEach(b=>{
    b.addEventListener('click',()=>location.href=b.dataset.link);
  });
  grid.querySelectorAll('.mission-btn').forEach(b=>{
    b.addEventListener('click',()=>claimXP(b.dataset.id));
  });
}

async function claimXP(id){
  const s=userState[id]||{done:false,claimed:false};
  if(!s.done) return alert('Báº¡n chÆ°a hoÃ n thÃ nh nhiá»‡m vá»¥!');
  if(s.claimed) return alert('Báº¡n Ä‘Ã£ nháº­n XP rá»“i!');
  const m=missions.find(x=>x.id===id); if(!m) return;

  s.claimed=true;
  userState[id]=s;
  localStorage.setItem('missions_state',JSON.stringify(userState));

  if(currentUser){
    const ref=doc(db,'users',currentUser.uid);
    const snap=await getDoc(ref);
    const prev=snap.exists()?snap.data().xp||0:0;
    const newXP=prev+m.xp;
    await setDoc(ref,{xp:newXP,missions:userState},{merge:true});
    await setDoc(doc(db,'leaderboard',currentUser.uid),{name:currentUser.email||'NgÆ°á»i dÃ¹ng',xp:newXP},{merge:true});
    updateXPUI(newXP);
  }else{
    localXP+=m.xp;
    localStorage.setItem('xp_local',localXP);
    updateXPUI(localXP);
  }
  renderMissions();
  alert(`+${m.xp} XP!`);
}

// gÃ³c áº©n danh
document.getElementById('sendAnon').addEventListener('click',async()=>{
  const nick=document.getElementById('anonNick').value.trim()||'áº¨n danh';
  const text=document.getElementById('anonText').value.trim();
  if(!text) return alert('HÃ£y viáº¿t gÃ¬ Ä‘Ã³!');
  await addDoc(collection(db,'anonMessages'),{nick,text,createdAt:new Date()});
  document.getElementById('anonText').value='';
});
onSnapshot(query(collection(db,'anonMessages'),orderBy('createdAt','desc'),limit(20)),snap=>{
  const box=document.getElementById('messagesBox');
  box.innerHTML='';
  snap.forEach(d=>{
    const v=d.data();
    const div=document.createElement('div');
    div.className='msg';
    div.innerHTML=`<b>${v.nick}</b><br>${v.text}`;
    box.appendChild(div);
  });
});

// báº£ng xáº¿p háº¡ng
onSnapshot(query(collection(db,'leaderboard'),orderBy('xp','desc'),limit(10)),snap=>{
  const lb=document.getElementById('leaderboard');
  lb.innerHTML='';
  snap.forEach(d=>{
    const v=d.data();
    const li=document.createElement('li');
    li.innerHTML=`<span>${v.name||'NgÆ°á»i'}</span><b>${v.xp||0} XP</b>`;
    lb.appendChild(li);
  });
});

// xÃ¡c thá»±c
onAuthStateChanged(auth,async u=>{
  currentUser=u;
  if(currentUser){
    const ref=doc(db,'users',u.uid);
    const snap=await getDoc(ref);
    if(snap.exists()){
      const d=snap.data();
      userState=d.missions||userState;
      updateXPUI(d.xp||0);
    }
  }else updateXPUI(localXP);
  renderMissions();
});
document.getElementById('loginQuick').addEventListener('click',()=>location.href='login.html');
</script>
</body>
</html>
