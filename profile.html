<!doctype html>
<html lang="vi">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Hồ sơ</title><link rel="stylesheet" href="style.css"></head>
<body>
<header class="nav"><div class="container nav-inner"><a href="index.html" class="brand">NHẬT KÍ<span>NĂNG LỰC</span></a></div></header>
<main class="page">
  <h1>👤 Hồ sơ</h1>
  <div id="nameBox">Người dùng</div>
  <div style="margin-top:12px">XP: <span id="xpBox">0</span></div>
  <div style="margin-top:8px">Cấp bậc: <span id="rankBox">Người khởi đầu</span></div>
  <div style="margin-top:12px" id="badgesBox"></div>
  <div style="margin-top:12px"><button id="syncBtn" class="btn">Đồng bộ hiển thị</button></div>
</main>

<script type="module">
import { auth, db } from './main.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

const xpBox = document.getElementById('xpBox');
const rankBox = document.getElementById('rankBox');
const badgesBox = document.getElementById('badgesBox');
const nameBox = document.getElementById('nameBox');

function getRank(xp){
  if(xp>=200) return 'Chuyên gia';
  if(xp>=100) return 'Thành thạo';
  if(xp>=50) return 'Người học tích cực';
  if(xp>=20) return 'Khám phá';
  return 'Người khởi đầu';
}

async function refreshProfile(){
  let xp = Number(localStorage.getItem('missions_xp_local')||0);
  let name = 'Khách';
  const user = auth.currentUser;
  if (user) {
    const snap = await getDoc(doc(db,'users',user.uid));
    if (snap.exists()) {
      const d = snap.data();
      xp = d.xp || xp;
      name = d.displayName || user.email || name;
    } else name = user.email || name;
  }
  xpBox.textContent = xp;
  rankBox.textContent = getRank(xp);
  nameBox.textContent = name;
  const badges = [];
  if (xp>=50) badges.push('🏅 Người học tích cực');
  if (xp>=100) badges.push('🎖 Nhà phản chiếu sâu sắc');
  if (xp>=200) badges.push('👑 Định hình năng lực');
  badgesBox.innerHTML = badges.map(b=>`<div style="display:inline-block;margin-right:8px">${b}</div>`).join('');
}

document.getElementById('syncBtn').addEventListener('click', refreshProfile);

onAuthStateChanged(auth, user => {
  refreshProfile();
});
</script>
</body>
</html>
